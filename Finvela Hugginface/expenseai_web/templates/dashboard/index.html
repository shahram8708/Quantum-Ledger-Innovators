{% extends 'base.html' %}
{% block page_title %}{{ _('Finvela Dashboard ¬∑ Invoice Intelligence') }}{% endblock %}
{% block meta_description %}{{ _('Monitor uploads, AI invoice summaries, and live finance activity inside Finvela\'s explainable automation workspace.') }}{% endblock %}
{% block meta_robots %}noindex,nofollow{% endblock %}
{% block head_extra %}
  <link rel="canonical" href="{{ url_for('expenseai_web.dashboard', _external=True) }}">
  <meta name="keywords" content="{{ _('AI invoice automation dashboard, finance workflow intelligence, Finvela live activity, expense analysis workspace') }}">
  <meta property="og:type" content="website">
  <meta property="og:title" content="{{ _('Finvela Dashboard ‚Ä¢ Invoice Intelligence') }}">
  <meta property="og:description" content="{{ _('Track uploads, AI insights, and system health in real time with Finvela\'s finance workspace.') }}">
  <meta property="og:url" content="{{ url_for('expenseai_web.dashboard', _external=True) }}">
  <meta property="og:image" content="{{ url_for('expenseai_web.static', filename='img/logo.png', _external=True) }}">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{ _('Finvela Dashboard') }}">
  <meta name="twitter:description" content="{{ _('Real-time invoice automation, compliance tracking, and risk monitoring.') }}">
  <meta name="twitter:image" content="{{ url_for('expenseai_web.static', filename='img/logo.png', _external=True) }}">
  <meta name="theme-color" content="#0d47a1">
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('expenseai_web.static', filename='img/logo.png') }}">
  <link rel="apple-touch-icon" href="{{ url_for('expenseai_web.static', filename='img/logo.png') }}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebPage",
    "name": "{{ _('Finvela Dashboard') }}",
    "url": "{{ url_for('expenseai_web.dashboard', _external=True) }}",
    "description": "{{ _('Authenticated dashboard for managing AI-driven invoice uploads, reviews, and live activity streams.') }}",
    "isPartOf": {
      "@type": "WebSite",
      "name": "{{ _('Finvela') }}",
      "url": "{{ url_for('expenseai_web.index', _external=True) }}"
    },
    "breadcrumb": {
      "@type": "BreadcrumbList",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "{{ _('Dashboard') }}",
          "item": "{{ url_for('expenseai_web.dashboard', _external=True) }}"
        }
      ]
    }
  }
  </script>
{% endblock %}
{% block content %}
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

  .dashboard-viewport {
    font-family: 'Inter', sans-serif;
    background: radial-gradient(circle at top left, rgba(14, 165, 233, 0.12), rgba(59, 130, 246, 0.12));
    min-height: 100vh;
    padding-bottom: 3rem;
  }

  .dash-glass-card {
    background: rgba(255, 255, 255, 0.96);
    border: 1px solid rgba(148, 163, 184, 0.18);
    backdrop-filter: blur(12px);
    box-shadow: 0 30px 80px -45px rgba(30, 64, 175, 0.45);
    border-radius: 2rem;
  }

  .dash-chip {
    border-radius: 9999px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  .dash-instruction {
    border-left: 4px solid rgba(59, 130, 246, 0.4);
    background: linear-gradient(135deg, rgba(14, 165, 233, 0.15), rgba(59, 130, 246, 0.12));
  }

  .dash-section-card {
    border-radius: 1.75rem;
    border: 1px solid rgba(148, 163, 184, 0.16);
    box-shadow: 0 20px 65px -50px rgba(30, 64, 175, 0.35);
  }

  .dropzone {
    border-radius: 1.25rem;
    transition: border-color 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease;
  }

  .dropzone:hover {
    border-color: rgba(59, 130, 246, 0.5);
    box-shadow: 0 20px 40px -35px rgba(59, 130, 246, 0.45);
    transform: translateY(-3px);
  }

  .avatar-circle {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    display: inline-flex;
    justify-content: center;
    align-items: center;
    background: rgba(59, 130, 246, 0.1);
    color: rgba(37, 99, 235, 0.9);
  }

  .status-badge {
    border-radius: 9999px;
    font-size: 0.75rem;
    text-transform: uppercase;
  }

  .btn-gradient-primary {
    background: linear-gradient(135deg, #2563eb, #7c3aed);
    border: none;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .btn-gradient-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 20px 40px -30px rgba(79, 70, 229, 0.6);
  }

  .btn-soft-primary {
    background: rgba(37, 99, 235, 0.08);
    border: 1px solid rgba(59, 130, 246, 0.2);
    color: #1d4ed8;
    transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
  }

  .btn-soft-primary:hover {
    background: rgba(59, 130, 246, 0.18);
    color: #1e3a8a;
    box-shadow: 0 18px 30px -24px rgba(37, 99, 235, 0.45);
    transform: translateY(-2px);
  }

  .btn-soft-primary:focus-visible {
    outline: 3px solid rgba(37, 99, 235, 0.35);
    outline-offset: 2px;
  }

  .hero-highlight-list {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin: 1.5rem 0 0;
    padding: 0;
  }

  .hero-highlight-item {
    background: rgba(255, 255, 255, 0.92);
    border: 1px solid rgba(148, 163, 184, 0.18);
    border-radius: 1.25rem;
    box-shadow: 0 16px 45px -36px rgba(30, 64, 175, 0.45);
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 1rem 1.25rem;
    width: fit-content;
    min-width: 16rem;
  }

  .hero-highlight-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 9999px;
    background: rgba(59, 130, 246, 0.12);
    width: 40px;
    height: 40px;
    font-size: 1.1rem;
  }

  .download-card {
    background: rgba(255, 255, 255, 0.98);
    border: 1px solid rgba(148, 163, 184, 0.16);
    border-radius: 2rem;
    box-shadow: 0 24px 75px -48px rgba(30, 64, 175, 0.4);
  }

  .glass-outline {
    backdrop-filter: blur(16px);
    border: 1px solid rgba(148, 163, 184, 0.2);
  }

  #activityPayloadTableWrapper {
    border-radius: 1rem;
  }

  @media (max-width: 991.98px) {
    .dash-glass-card,
    .dash-section-card {
      border-radius: 1.5rem;
    }
  }

  @media (max-width: 575.98px) {
    .hero-highlight-item {
      min-width: auto;
      width: 100%;
    }
  }
</style>

<div>
  <div class="container-xl">
    <section class="dash-glass-card px-4 px-lg-5 py-5 animate-fade-up">
      <div class="row align-items-center gy-5">
        <div class="col-lg-12">
          <span class="badge bg-primary-subtle text-primary-emphasis dash-chip px-3 py-2">{{ _('Finvela Platform') }}</span>
          <h1 class="display-4 fw-bold mb-3 mt-3">{{ _('Invoice intelligence built for decisive finance teams.') }}</h1>
          <p class="lead text-secondary mb-0">{{ _('Finvela unifies automated invoice inspection, audit-ready controls, and collaborative review workflows inside a secure platform that scales with your operations.') }}</p>
          <ul class="hero-highlight-list list-unstyled mb-0">
            <li class="hero-highlight-item">
              <span class="hero-highlight-icon text-primary"><i class="bi bi-shield-check"></i></span>
              <div>
                <span class="fw-semibold d-block">{{ _('Compliance ready') }}</span>
                <span class="small text-muted">{{ _('Granular audit logs and SOC-aligned policies from day one.') }}</span>
              </div>
            </li>
            <li class="hero-highlight-item">
              <span class="hero-highlight-icon text-primary"><i class="bi bi-speedometer2"></i></span>
              <div>
                <span class="fw-semibold d-block">{{ _('Realtime context') }}</span>
                <span class="small text-muted">{{ _('Streaming diagnostics, SLA monitoring, and proactive alerts.') }}</span>
              </div>
            </li>
            <li class="hero-highlight-item">
              <span class="hero-highlight-icon text-primary"><i class="bi bi-people"></i></span>
              <div>
                <span class="fw-semibold d-block">{{ _('Team-first UX') }}</span>
                <span class="small text-muted">{{ _('Role-based workspaces for finance, audit, and risk stakeholders.') }}</span>
              </div>
            </li>
          </ul>
          <div class="alert dash-instruction border-0 shadow-sm mt-4" role="alert">
            <div class="d-flex align-items-start gap-3">
              <span class="fs-4">üß≠</span>
              <div>
                <h2 class="h6 fw-semibold mb-1">{{ _('Kick off implementation') }}</h2>
                <p class="small mb-0">{{ _('Provision your organization account, review AI-assisted invoice flows, and validate queue performance before inviting the wider team.') }}</p>
              </div>
            </div>
          </div>
          <div class="d-flex flex-column flex-sm-row flex-wrap gap-3 mt-4">
            <a href="#upload" class="btn btn-gradient-primary btn-lg text-white"><i class="bi bi-rocket-takeoff me-2"></i>{{ _('Get started') }}</a>
            <a href="{{ url_for('expenseai_web.health') }}" class="btn btn-outline-primary btn-lg" data-bs-toggle="tooltip" data-bs-placement="bottom" title="{{ _('Review system uptime, queue usage, and task throughput') }}"><i class="bi bi-activity me-2"></i>{{ _('System health') }}</a>
            <a href="{{ url_for('expenseai_web.static', filename='app/finvela.apk') }}" class="btn btn-soft-primary btn-lg"><i class="bi bi-download me-2"></i>{{ _('Download application') }}</a>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div class="container-xxl py-4">

    <section class="animate-fade-up mb-4">
      <div class="alert dash-instruction border-0 shadow-sm" role="alert">
        <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3">
          <div class="d-flex align-items-start gap-3">
            <span class="fs-3">üß≠</span>
            <div>
              <h2 class="h6 fw-semibold mb-1">{{ _('Workspace overview') }}</h2>
              <p class="small mb-0">{{ _('Upload invoices on the left, review AI summaries below, and monitor live events on the right. Tooltips and badges highlight each action.') }}</p>
            </div>
          </div>
          {% if last_invoice %}
          <a class="btn btn-outline-primary btn-sm" href="{{ url_for('expenseai_invoices.invoice_detail', invoice_id=last_invoice.id) }}">
            <i class="bi bi-box-arrow-up-right me-1"></i>{{ _('Open last upload') }}
          </a>
          {% endif %}
        </div>
      </div>
    </section>

    <div class="row g-4 animate-fade-up" id="upload">
      <div class="col-12 col-xxl-8">
        <section class="card dash-section-card border-0 mb-4" aria-labelledby="uploadHeading">
          <div class="card-header bg-transparent border-0 pb-0 d-flex justify-content-between align-items-start flex-wrap gap-3">
            <div>
              <h2 class="h4 fw-bold mb-1" id="uploadHeading"><i class="bi bi-cloud-arrow-up me-2"></i>{{ _('Upload invoices') }}</h2>
              <p class="text-muted small mb-0">{{ _('Drag and drop PDF, PNG, or JPEG files (%(limit)s MB max).', limit=max_upload_mb) }}</p>
            </div>
            <span class="badge bg-primary-subtle text-primary-emphasis dash-chip px-3 py-2">{{ _('Step 1') }}</span>
          </div>
          <div class="card-body">
            <div class="alert alert-info bg-info-subtle border-0 text-info-emphasis" role="alert">
              <div class="d-flex align-items-start gap-2">
                <span class="fs-5">üí°</span>
                <p class="small mb-0">{{ _('Drop one file at a time for the cleanest audit trail. The upload button activates automatically when a file is ready.') }}</p>
              </div>
            </div>
            <form id="invoiceUploadForm" class="upload-form" method="post" action="{{ url_for('expenseai_invoices.upload_invoice') }}" enctype="multipart/form-data" novalidate>
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <div id="uploadDropzone" class="dropzone glass-outline border border-dashed text-center p-4" tabindex="0" role="button" aria-describedby="uploadHelp">
                <i class="bi bi-cloud-upload display-6 mb-3 text-primary"></i>
                <p class="lead mb-1">{{ _('Drop files here or click to browse') }}</p>
                <p class="text-muted small" id="uploadHelp">{{ _('Accepts .pdf, .jpg, .jpeg, .png. Maximum size %(limit)s MB.', limit=max_upload_mb) }}</p>
                <p class="text-muted small visually-hidden mt-2" data-upload-selected></p>
                <input class="visually-hidden" type="file" id="invoiceFileInput" name="file" accept=".pdf,.png,.jpg,.jpeg" aria-label="{{ _('Invoice file input') }}">
                <button type="button" class="btn btn-outline-secondary mt-3" id="browseButton"><i class="bi bi-folder2-open me-1"></i>{{ _('Choose file') }}</button>
              </div>
              <button type="submit" name="submit" class="btn btn-gradient-primary mt-3 visually-hidden text-white" data-upload-submit>
                <i class="bi bi-cloud-arrow-up me-1"></i>{{ _('Upload file') }}
              </button>
              <div class="progress mt-3 visually-hidden" id="uploadProgressWrapper" aria-hidden="true">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" id="uploadProgressBar"></div>
              </div>
              <p class="text-danger small mt-2" id="uploadError" role="alert" hidden></p>
            </form>
          </div>
        </section>

        <section class="card dash-section-card border-0" aria-labelledby="recentInvoicesHeading">
          <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div>
              <h2 class="h4 fw-bold mb-1" id="recentInvoicesHeading"><i class="bi bi-files-alt me-2"></i>{{ _('Recent invoices') }}</h2>
              <p class="text-muted small mb-0">{{ _('Latest uploads across your workspace.') }}</p>
            </div>
            <div class="d-flex align-items-center gap-2">
              <span class="badge bg-success-subtle text-success-emphasis dash-chip px-3 py-2">{{ _('Step 2') }}</span>
              <a class="btn btn-primary btn-sm" href="{{ url_for('expenseai_invoices.list_invoices') }}" data-bs-toggle="tooltip" data-bs-placement="bottom" title="{{ _('See the full archive of processed invoices') }}"><i class="bi bi-collection me-1"></i>{{ _('View all') }}</a>
            </div>
          </div>
          <div class="card-body pt-0">
            <div class="alert alert-success bg-success-subtle border-0 text-success-emphasis" role="alert">
              <div class="d-flex align-items-start gap-2">
                <span class="fs-5">üìÇ</span>
                <p class="small mb-0">{{ _('Open an invoice row to jump straight into the AI analysis view. Status badges reveal progress‚Äîprocessing, complete, or flagged.') }}</p>
              </div>
            </div>
          </div>
          <div class="list-group list-group-flush" id="recentInvoicesList">
            {% if recent_invoices %}
            {% for invoice in recent_invoices %}
            <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-start gap-3" href="{{ url_for('expenseai_invoices.invoice_detail', invoice_id=invoice.id) }}">
              <div class="d-flex gap-3 align-items-start">
                {% if invoice.thumbnail_url() %}
                <img src="{{ invoice.thumbnail_url() }}" alt="{{ _('Thumbnail for %(filename)s', filename=invoice.original_filename or _('Invoice file')) }}" class="rounded object-fit-cover preview-thumb" width="56" height="56" loading="lazy">
                {% else %}
                <span class="avatar-circle" aria-hidden="true"><i class="bi bi-file-earmark-text"></i></span>
                {% endif %}
                <div>
                  <h3 class="h6 mb-1 text-truncate" title="{{ invoice.original_filename }}">{{ invoice.original_filename }}</h3>
                  <p class="text-muted small mb-1">{{ invoice.mime_type }} ¬∑ {{ (invoice.filesize_bytes / 1024) | round(1) }} KB</p>
                  <span class="badge status-badge status-{{ invoice.processing_status|lower }}">{{ invoice.processing_status.title() }}</span>
                </div>
              </div>
              <div class="text-end">
                <span class="small text-muted">{{ invoice.created_at.strftime('%b %d, %H:%M') }}</span>
                {% if invoice.vendor_gst or invoice.invoice_no %}
                <div class="small text-muted">{{ invoice.vendor_gst }} ¬∑ {{ invoice.invoice_no }}</div>
                {% endif %}
              </div>
            </a>
            {% endfor %}
            {% else %}
            <div class="list-group-item py-5 text-center text-muted">
              <i class="bi bi-inbox mb-2 d-block fs-4"></i>{{ _('No invoices yet ‚Äî drag & drop a file to start.') }}
            </div>
            {% endif %}
          </div>
        </section>
      </div>

      <div class="col-12 col-xxl-4">
        <section class="card dash-section-card border-0 h-100" aria-labelledby="activityHeading">
          <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-start flex-wrap gap-3">
            <div>
              <h2 class="h4 fw-bold mb-1" id="activityHeading"><i class="bi bi-activity me-2"></i>{{ _('Live activity') }}</h2>
              <p class="text-muted small mb-0">{{ _('Realtime updates stream in as events occur.') }}</p>
            </div>
            <div class="d-flex flex-column align-items-end gap-2">
              <span class="badge bg-info-subtle text-info-emphasis dash-chip px-3 py-2">{{ _('Step 3') }}</span>
              <span id="sseStatus" class="badge text-bg-secondary" data-bs-toggle="tooltip" data-bs-placement="left" title="{{ _('Tracks server-sent events for ongoing processes') }}"><i class="bi bi-broadcast me-1"></i>{{ _('Offline') }}</span>
            </div>
          </div>
          <div class="card-body pt-0">
            <div class="alert alert-secondary bg-secondary-subtle border-0 text-secondary-emphasis" role="alert">
              <div class="d-flex align-items-start gap-2">
                <span class="fs-5">üì°</span>
                <p class="small mb-0">{{ _('Select ‚ÄúView payload‚Äù to open structured JSON for the event right from this panel. Ideal for debugging integrations.') }}</p>
              </div>
            </div>
          </div>
          <div class="list-group list-group-flush" id="activityFeed" role="list" data-activity-table-enabled="true">
            {% if recent_events %}
            {% for event in recent_events %}
            {% set payload = event.payload %}
            {% set has_payload = payload not in (None, {}, [], '') %}
            <div class="list-group-item" role="listitem"
                 data-activity-item
                 data-event-id="{{ event.id }}"
                 data-event-type="{{ event.event_type }}"
                 data-event-created="{{ event.created_at.strftime('%b %d, %Y %H:%M:%S') }}"
                 data-event-invoice="{{ event.invoice_id }}"
                 data-event-payload='{{ payload | tojson | safe }}'>
              <div class="d-flex justify-content-between align-items-start gap-3 flex-wrap">
                <div>
                  <span class="badge rounded-pill text-bg-light text-uppercase mb-2">{{ event.event_type }}</span>
                  <p class="mb-1">{{ _('Invoice #%(invoice_id)s', invoice_id=event.invoice_id) }}</p>
                  <button type="button" class="btn btn-outline-primary btn-sm" data-activity-payload-trigger {% if not has_payload %}disabled{% endif %}>
                    <i class="bi bi-table"></i><span class="ms-1">{{ _('View payload') }}</span>
                  </button>
                </div>
                <span class="small text-muted">{{ event.created_at.strftime('%b %d, %Y %H:%M:%S') }}</span>
              </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="list-group-item py-5 text-center text-muted" data-empty-state="true">
              <i class="bi bi-robot mb-2 d-block fs-4"></i>{{ _('Activity will appear here after your first upload.') }}
            </div>
            {% endif %}
          </div>
        </section>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="activityPayloadModal" tabindex="-1" aria-labelledby="activityPayloadModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="activityPayloadModalLabel">{{ _('Activity payload') }}</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
      </div>
      <div class="modal-body">
        <div id="activityPayloadMeta" class="text-muted small mb-3"></div>
        <div class="table-responsive border rounded shadow-sm" id="activityPayloadTableWrapper">
          <table class="table table-sm table-striped table-hover align-middle mb-0" id="activityPayloadTable">
            <thead class="table-light">
              <tr>
                <th scope="col" style="width: 40%;">{{ _('Field') }}</th>
                <th scope="col">{{ _('Value') }}</th>
              </tr>
            </thead>
            <tbody id="activityPayloadTableBody">
              <tr>
                <td colspan="2" class="text-center text-muted">{{ _('Select an event to inspect its payload.') }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div id="activityPayloadEmpty" class="alert alert-secondary small mt-3 d-none" role="status">
          {{ _('No structured payload was provided for this event.') }}
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">{{ _('Close') }}</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
